# Catalyst Trading System - Fixes Summary

**Date:** 2026-01-01
**Session:** New Year's Day Maintenance
**Author:** Claude Code

---

## Issues Fixed

### 1. Bracket Orders Expiring Daily (CRITICAL)

**Problem:** All bracket orders (stop-loss + take-profit) were set with `TimeInForce.DAY`, causing them to expire at market close (4 PM ET) every day.

**Impact:**
- No positions ever closed via stop-loss or take-profit
- 36 open positions with no exit mechanism
- Stop-loss orders cancelled when take-profit expired

**Root Cause:** In `alpaca_trader.py`, bracket orders used:
```python
time_in_force=TimeInForce.DAY  # Expires at market close
```

**Fix Applied:** Changed to:
```python
time_in_force=TimeInForce.GTC  # Good Till Canceled - persists across days
```

**Files Modified:**
- `services/shared/common/alpaca_trader.py` (v2.0.0 â†’ v2.1.0)
- `services/trading/common/alpaca_trader.py`
- `services/workflow/common/alpaca_trader.py`
- `services/risk-manager/common/alpaca_trader.py`

---

### 2. Daily Report Generation Failing

**Problem:** Cron job for daily reports was failing with:
```
ERROR: DATABASE_URL environment variable is required
```

**Root Cause:** The cron used `source .env` which sets shell variables but doesn't export them for Python's `os.getenv()`.

**Fix Applied:** Updated cron entry:
```bash
# Before
source .env && python3 scripts/generate-daily-report.py

# After
set -a && source .env && set +a && python3 scripts/generate_daily_report_db.py
```

The `set -a` flag exports all variables.

---

### 3. Report Schema Mismatch

**Problem:** Report generation scripts referenced `p.alpaca_status` column which doesn't exist in the positions table.

**Fix Applied:** Removed `alpaca_status` references from:
- `scripts/generate-daily-report.py` (lines 99, 141, 276)
- `scripts/generate_daily_report_db.py` (lines 115, 160)

---

### 4. New Database Report Storage

**Enhancement:** Reports now stored in `claude_reports` table instead of GitHub markdown files.

**Benefits:**
- Queryable via SQL
- Structured metrics in JSONB
- Dashboard accessible
- No git credentials needed

**New Files:**
- `scripts/generate_daily_report_db.py` - Database report generator
- `Documentation/Implementation/DEPLOY_US_REPORTS.md` - Deployment guide

---

## Trading Status

### Open Positions: 36

| Date | Positions | Capital |
|------|-----------|---------|
| Dec 31, 2025 | 11 | $31,800 |
| Dec 30, 2025 | 11 | $52,104 |
| Dec 28, 2025 | 14 | $41,834 |
| **Total** | **36** | **$125,738** |

### Account Summary (Dec 31)
- Portfolio Value: $94,635.18
- Daily P&L: -$1,047.56 (-1.07%)
- All positions LONG with 200 shares each

### Historical Closures
All 141 closed positions were from:
- Order side bug cleanup (v1.2.0): 81 positions
- Historical cleanup: 37 positions
- Alpaca expired orders: 19 positions
- Orphaned cleanup: 4 positions

**No positions have closed via stop-loss or take-profit** (now fixed with GTC).

---

## Containers Rebuilt

| Service | Status |
|---------|--------|
| trading | Rebuilt with GTC fix |
| workflow | Rebuilt with GTC fix |
| risk-manager | Rebuilt with GTC fix |

Will take effect at next container start (9:00 PM AWST / 8:00 AM ET).

---

## Cron Jobs Tested

| Job | Status |
|-----|--------|
| Report Generation | PASS |
| Health Check | PASS |
| Budget Reset | PASS |
| Heartbeat (big_bro) | PASS |
| Heartbeat (public_claude) | PASS |

---

## Reports Generated

| Date | Location |
|------|----------|
| Dec 30, 2025 | Database: claude_reports (id=2) |
| Dec 31, 2025 | Database: claude_reports (id=5) |

---

## Next Steps

1. Monitor next trading session for bracket order persistence
2. Verify positions close when hitting stop-loss/take-profit
3. Review position P&L after market activity

---

*Generated by Claude Code - 2026-01-01*
