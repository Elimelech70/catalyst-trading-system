# Catalyst Trading System - Comprehensive Workflow & Audit Report

**Name of Application**: Catalyst Trading System  
**Name of file**: catalyst-workflows-and-audit.md  
**Version**: 1.0.0  
**Last Updated**: 2025-12-27  
**Purpose**: Complete workflow documentation with implementation audit  
**Author**: Claude Opus 4.5 (Audit Session)

---

## DOCUMENT STRUCTURE

1. [Executive Summary](#1-executive-summary)
2. [System Architecture Overview](#2-system-architecture-overview)
3. [Complete Workflow Diagrams](#3-complete-workflow-diagrams)
4. [Service-by-Service Audit](#4-service-by-service-audit)
5. [Database Schema Audit](#5-database-schema-audit)
6. [Discrepancies Found](#6-discrepancies-found)
7. [Recommendations](#7-recommendations)

---

## 1. Executive Summary

### 1.1 Design Documents (Source of Truth)

| Document | Version | Last Updated | Status |
|----------|---------|--------------|--------|
| `architecture.md` | v7.0.0 | 2025-12-27 | âœ… Current |
| `functional-specification.md` | v7.0.0 | 2025-12-27 | âœ… Current |
| `database-schema.md` | v7.0.0 | 2025-12-27 | âœ… Current |
| `operations.md` | v1.0.0 | 2025-12-27 | âœ… Current |
| `ARCHITECTURE-RULES.md` | v1.0.0 | 2025-12-27 | âœ… Current |

### 1.2 Implementation Files Audited

| Service | File | Version | Port | Status |
|---------|------|---------|------|--------|
| Orchestration | `orchestration-service.py` | v6.0.3 | 5000 | âœ… Audited |
| Scanner | `scanner-service.py` | v6.1.0 | 5001 | âœ… Audited |
| Pattern | `pattern-service.py` | - | 5002 | âœ… Audited |
| Technical | `technical-service.py` | - | 5003 | âœ… Audited |
| Risk Manager | `risk-manager-service.py` | v7.1.0 | 5004 | âœ… Audited |
| Trading | `trading-service.py` | v8.3.0 | 5005 | âš ï¸ Schema violation |
| Workflow | `workflow-service.py` | v6.0.0 | 5006 | âœ… Audited |
| News | `news-service.py` | v6.0.1 | 5008 | âœ… Audited |
| Reporting | `reporting-service.py` | v5.1.1 | 5009 | âœ… Audited |
| Doctor Claude | Multiple scripts | v1.0.0 | N/A | âœ… Audited |

### 1.3 Critical Finding Summary

| Severity | Count | Description |
|----------|-------|-------------|
| ğŸ”´ CRITICAL | 2 | Orders stored in positions table (violates ARCHITECTURE-RULES), alpaca_trader.py duplication |
| ğŸŸ¡ WARNING | 5 | Port discrepancy in IMPLEMENTATION-GUIDE.md, dual workflow files, version mismatches, news schema column error, pattern service missing version |
| ğŸ”µ INFO | 4 | Dual pattern implementations, Dockerfile versions, operations.md new, catalyst-international separation |

### 1.4 Port Assignment Discrepancy (RESOLVED)

**IMPLEMENTATION-GUIDE.md (WRONG):**
```
News=5002, Pattern=5003, Technical=5004, Risk=5005, Trading=5006, Workflow=5007
```

**functional-specification.md v7.0.0 (CORRECT - Source of Truth):**
```
Scanner=5001, Pattern=5002, Technical=5003, Risk=5004, Trading=5005, Workflow=5006, News=5008, Reporting=5009
```

**Action Required:** Update IMPLEMENTATION-GUIDE.md to match functional-specification.md

---

## 2. System Architecture Overview

### 2.1 High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CATALYST TRADING SYSTEM                             â”‚
â”‚                              US Markets (Alpaca)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              INTERFACE LAYER                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Claude Desktop    â”‚â—€â”€â”€â”€â”€ MCP â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    Orchestration (5000)    â”‚ â”‚
â”‚  â”‚  (Human Oversight)  â”‚                    â”‚    - MCP Protocol Handler   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚    - Tool Routing           â”‚ â”‚
â”‚                                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â”‚ REST API
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ORCHESTRATION LAYER                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                        Workflow Service (5006)                          â”‚â”‚
â”‚  â”‚   - Trading cycle coordination                                           â”‚â”‚
â”‚  â”‚   - Service orchestration                                                â”‚â”‚
â”‚  â”‚   - State management                                                     â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                  â”‚                  â”‚
                    â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ANALYSIS LAYER                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Scanner (5001)   â”‚  â”‚  Pattern (5002)   â”‚  â”‚   Technical (5003)       â”‚â”‚
â”‚  â”‚  - Universe scan  â”‚  â”‚  - Chart patterns â”‚  â”‚   - RSI, MACD, ATR       â”‚â”‚
â”‚  â”‚  - Volume filter  â”‚  â”‚  - Bull/Bear flagsâ”‚  â”‚   - Moving averages      â”‚â”‚
â”‚  â”‚  - Gap detection  â”‚  â”‚  - Breakouts      â”‚  â”‚   - Momentum indicators  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                          News Service (5008)                          â”‚  â”‚
â”‚  â”‚   - Catalyst detection     - Sentiment analysis    - Event filtering  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           EXECUTION LAYER                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚     Risk Manager (5004)       â”‚  â”‚         Trading Service (5005)        â”‚â”‚
â”‚  â”‚  - Position sizing            â”‚â”€â”€â–¶â”‚  - Order creation                     â”‚â”‚
â”‚  â”‚  - Daily loss limits          â”‚  â”‚  - Alpaca API integration             â”‚â”‚
â”‚  â”‚  - Sector exposure            â”‚  â”‚  - Bracket order execution            â”‚â”‚
â”‚  â”‚  - Emergency stop             â”‚  â”‚  - Position management                â”‚â”‚
â”‚  â”‚  - Position monitoring        â”‚  â”‚  - Order status sync                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           EXTERNAL SYSTEMS                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚        Alpaca Markets         â”‚  â”‚      DigitalOcean PostgreSQL         â”‚â”‚
â”‚  â”‚  - Paper/Live trading         â”‚  â”‚  - 3NF normalized schema             â”‚â”‚
â”‚  â”‚  - Order execution            â”‚  â”‚  - Trading cycles                    â”‚â”‚
â”‚  â”‚  - Position data              â”‚  â”‚  - Orders & positions                â”‚â”‚
â”‚  â”‚  - Market data                â”‚  â”‚  - Audit logs                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MONITORING LAYER                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                         Doctor Claude                                     â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚ trade_watchdog  â”‚  â”‚ log_activity    â”‚  â”‚ doctor_claude_monitor.sh   â”‚â”‚â”‚
â”‚  â”‚  â”‚ - Diagnostics   â”‚  â”‚ - Audit trail   â”‚  â”‚ - Continuous loop          â”‚â”‚â”‚
â”‚  â”‚  â”‚ - JSON output   â”‚  â”‚ - DB logging    â”‚  â”‚ - Auto-fix decisions       â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                      Reporting Service (5009)                             â”‚â”‚
â”‚  â”‚   - Performance analytics    - P&L tracking    - Daily summaries         â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          INFRASTRUCTURE                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Docker Compose   â”‚  â”‚   Redis (6379)     â”‚  â”‚      Nginx             â”‚ â”‚
â”‚  â”‚   - 9 containers   â”‚  â”‚   - Caching        â”‚  â”‚   - SSL termination    â”‚ â”‚
â”‚  â”‚   - Health checks  â”‚  â”‚   - Pub/Sub        â”‚  â”‚   - Reverse proxy      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Service Port Matrix (AUTHORITATIVE)

From `functional-specification.md` v7.0.0 (Source of Truth):

| # | Service | Port | Protocol | Status |
|---|---------|------|----------|--------|
| 1 | Orchestration | 5000 | MCP + REST | âœ… Confirmed |
| 2 | Scanner | 5001 | REST | âœ… Confirmed |
| 3 | Pattern | 5002 | REST | âœ… Confirmed |
| 4 | Technical | 5003 | REST | âœ… Confirmed |
| 5 | Risk Manager | 5004 | REST | âœ… Confirmed |
| 6 | Trading | 5005 | REST | âœ… Confirmed |
| 7 | Workflow | 5006 | REST | âœ… Confirmed |
| 8 | News | 5008 | REST | âœ… Confirmed |
| 9 | Reporting | 5009 | REST | âœ… Confirmed |
| 10 | Redis | 6379 | Redis | âœ… Confirmed |

---

## 3. Complete Workflow Diagrams

### 3.1 WORKFLOW A: Daily Trading Cycle (CRON-Initiated)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DAILY TRADING CYCLE WORKFLOW                              â”‚
â”‚                    (Automated via CRON)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TIME (ET)    COMPONENT           ACTION                          DATABASE STATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

09:15 AM     CRON                trigger-workflow.sh              
    â”‚                                   â”‚
    â–¼                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pre-Mkt â”‚   Workflow(5006)     â”‚ INSERT trading_cycles                       â”‚
â”‚  Scan   â”‚   POST /start        â”‚   status='scanning'                         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚  HTTP POST
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PHASE 1: SCANNING                                  â”‚
â”‚                                                                              â”‚
â”‚  Workflow â”€â”€â”€â”€â”€â–¶ Scanner(5001) â”€â”€â”€â”€â”€â–¶ Alpaca API                            â”‚
â”‚                  POST /scan                                                  â”‚
â”‚                       â”‚                                                      â”‚
â”‚                       â”œâ”€â”€ Get tradeable universe (4000+ stocks)              â”‚
â”‚                       â”œâ”€â”€ Filter: Volume > 500K                              â”‚
â”‚                       â”œâ”€â”€ Filter: Gap > 2%                                   â”‚
â”‚                       â””â”€â”€ Return Top 100                                     â”‚
â”‚                                                                              â”‚
â”‚  Database: INSERT scan_results (100 candidates)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PHASE 2: NEWS FILTERING                               â”‚
â”‚                                                                              â”‚
â”‚  Workflow â”€â”€â”€â”€â”€â–¶ News(5008) â”€â”€â”€â”€â”€â–¶ News APIs                                â”‚
â”‚                  POST /analyze                                               â”‚
â”‚                       â”‚                                                      â”‚
â”‚                       â”œâ”€â”€ Check each candidate for catalysts                 â”‚
â”‚                       â”œâ”€â”€ Sentiment analysis                                 â”‚
â”‚                       â””â”€â”€ Return ~35 with catalysts                          â”‚
â”‚                                                                              â”‚
â”‚  Database: UPDATE scan_results SET has_catalyst = true                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       PHASE 3: PATTERN ANALYSIS                              â”‚
â”‚                                                                              â”‚
â”‚  Workflow â”€â”€â”€â”€â”€â–¶ Pattern(5002) â”€â”€â”€â”€â”€â–¶ Chart Analysis                        â”‚
â”‚                  POST /analyze                                               â”‚
â”‚                       â”‚                                                      â”‚
â”‚                       â”œâ”€â”€ Bull/Bear flag detection                           â”‚
â”‚                       â”œâ”€â”€ Breakout patterns                                  â”‚
â”‚                       â”œâ”€â”€ Support/Resistance levels                          â”‚
â”‚                       â””â”€â”€ Return ~20 with patterns                           â”‚
â”‚                                                                              â”‚
â”‚  Database: UPDATE scan_results SET pattern_type = '...'                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PHASE 4: TECHNICAL ANALYSIS                             â”‚
â”‚                                                                              â”‚
â”‚  Workflow â”€â”€â”€â”€â”€â–¶ Technical(5003) â”€â”€â”€â”€â”€â–¶ Indicator Calculation               â”‚
â”‚                  POST /analyze                                               â”‚
â”‚                       â”‚                                                      â”‚
â”‚                       â”œâ”€â”€ RSI, MACD, ATR                                     â”‚
â”‚                       â”œâ”€â”€ Moving averages                                    â”‚
â”‚                       â”œâ”€â”€ Volume analysis                                    â”‚
â”‚                       â””â”€â”€ Return ~10 scored candidates                       â”‚
â”‚                                                                              â”‚
â”‚  Database: UPDATE scan_results SET technical_score = ...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PHASE 5: RISK VALIDATION                                â”‚
â”‚                                                                              â”‚
â”‚  Workflow â”€â”€â”€â”€â”€â–¶ Risk Manager(5004) â”€â”€â”€â”€â”€â–¶ Risk Checks                      â”‚
â”‚                  POST /validate                                              â”‚
â”‚                       â”‚                                                      â”‚
â”‚                       â”œâ”€â”€ Position size calculation (2% max)                 â”‚
â”‚                       â”œâ”€â”€ Daily loss limit check ($2,000)                    â”‚
â”‚                       â”œâ”€â”€ Max positions check (5)                            â”‚
â”‚                       â”œâ”€â”€ Sector exposure check (40%)                        â”‚
â”‚                       â””â”€â”€ Return 5 approved candidates                       â”‚
â”‚                                                                              â”‚
â”‚  Database: UPDATE trading_cycles SET status='evaluating'                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
09:30 AM     MARKET OPEN
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PHASE 6: ORDER EXECUTION                                â”‚
â”‚                                                                              â”‚
â”‚  For each approved candidate:                                                â”‚
â”‚                                                                              â”‚
â”‚  Workflow â”€â”€â”€â”€â”€â–¶ Trading(5005) â”€â”€â”€â”€â”€â–¶ Alpaca API                            â”‚
â”‚                  POST /orders                                                â”‚
â”‚                       â”‚                                                      â”‚
â”‚                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                       â”‚  â”‚ ORDER FIRST, POSITION AFTER (Golden Rule)       â”‚â”‚
â”‚                       â”‚  â”‚                                                  â”‚â”‚
â”‚                       â”‚  â”‚ 1. INSERT INTO orders (status='created')        â”‚â”‚
â”‚                       â”‚  â”‚ 2. Submit bracket order to Alpaca               â”‚â”‚
â”‚                       â”‚  â”‚ 3. UPDATE orders (alpaca_order_id, 'submitted') â”‚â”‚
â”‚                       â”‚  â”‚ 4. Wait for fill...                             â”‚â”‚
â”‚                       â”‚  â”‚ 5. On fill: INSERT INTO positions               â”‚â”‚
â”‚                       â”‚  â”‚ 6. Link order to position                       â”‚â”‚
â”‚                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                              â”‚
â”‚  Database: trading_cycles.status = 'trading'                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PHASE 7: POSITION MONITORING                            â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    CONTINUOUS MONITORING LOOP                           â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  Every 60 seconds:                                                      â”‚â”‚
â”‚  â”‚    Risk Manager â”€â”€â–¶ Check daily P&L                                     â”‚â”‚
â”‚  â”‚                 â”€â”€â–¶ Monitor all open positions                          â”‚â”‚
â”‚  â”‚                 â”€â”€â–¶ Trigger emergency stop if limit hit                 â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  Every 30 seconds (PositionMonitor):                                    â”‚â”‚
â”‚  â”‚    Fallback stop-loss enforcement                                       â”‚â”‚
â”‚  â”‚    (Backup for Alpaca bracket failures)                                 â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  Every 60 seconds (Trading Service):                                    â”‚â”‚
â”‚  â”‚    Sync order statuses from Alpaca                                      â”‚â”‚
â”‚  â”‚    Detect ghost positions                                               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                              â”‚
â”‚  Database: trading_cycles.status = 'monitoring'                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
04:00 PM     MARKET CLOSE
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      PHASE 8: END OF DAY                                     â”‚
â”‚                                                                              â”‚
â”‚  CRON: close-positions.sh                                                    â”‚
â”‚                                                                              â”‚
â”‚  1. Trading(5005) â”€â”€â–¶ Close all open positions                              â”‚
â”‚  2. Reporting(5009) â”€â”€â–¶ Calculate daily P&L                                 â”‚
â”‚  3. Alert Manager â”€â”€â–¶ Send daily summary email                              â”‚
â”‚                                                                              â”‚
â”‚  Database: trading_cycles.status = 'closed' â†’ 'completed'                    â”‚
â”‚            positions.status = 'closed'                                       â”‚
â”‚            positions.realized_pnl = calculated                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 WORKFLOW B: Order Lifecycle (Order-First Pattern)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ORDER LIFECYCLE WORKFLOW                             â”‚
â”‚                    (ORDER FIRST, POSITION AFTER)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP   DATABASE                    ALPACA                    NOTES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. CREATE ORDER RECORD (Before Alpaca!)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ INSERT INTO orders             â”‚
   â”‚   security_id = (AAPL's ID)    â”‚
   â”‚   cycle_id = current_cycle     â”‚
   â”‚   side = 'buy'                 â”‚
   â”‚   order_type = 'market'        â”‚
   â”‚   quantity = 100               â”‚
   â”‚   status = 'created'           â”‚  â† Local state only
   â”‚   position_id = NULL           â”‚  â† No position yet!
   â”‚ RETURNING order_id             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
2. SUBMIT TO ALPACA
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   Trading Service                          Alpaca API
        â”‚                                        â”‚
        â”‚  submit_bracket_order(                 â”‚
        â”‚    symbol='AAPL',                      â”‚
        â”‚    quantity=100,                       â”‚
        â”‚    side='buy',                         â”‚
        â”‚    entry_price=150.00,                 â”‚
        â”‚    stop_loss=145.00,                   â”‚
        â”‚    take_profit=160.00,                 â”‚
        â”‚    order_class=BRACKET  â† CRITICAL!   â”‚
        â”‚  )                                     â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
        â”‚                                        â”‚
        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚  Returns:                              â”‚
        â”‚    alpaca_order_id = 'abc-123'         â”‚
        â”‚    status = 'accepted'                 â”‚
        â”‚                                        â”‚
        â–¼
3. UPDATE ORDER WITH ALPACA RESPONSE
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ UPDATE orders SET              â”‚
   â”‚   alpaca_order_id = 'abc-123'  â”‚
   â”‚   status = 'submitted'         â”‚  â† Now tracking broker
   â”‚ WHERE order_id = ord-001       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
4. WAIT FOR FILL (Background sync every 60s)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   Trading Service                          Alpaca API
        â”‚                                        â”‚
        â”‚  get_order_by_id('abc-123')           â”‚
        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
        â”‚                                        â”‚
        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
        â”‚  Returns:                              â”‚
        â”‚    status = 'filled'                   â”‚
        â”‚    filled_avg_price = 149.95           â”‚
        â”‚    filled_qty = 100                    â”‚
        â”‚                                        â”‚
        â–¼
5. ENTRY FILLS â†’ CREATE POSITION
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ UPDATE orders SET              â”‚
   â”‚   status = 'filled'            â”‚
   â”‚   filled_qty = 100             â”‚
   â”‚   filled_price = 149.95        â”‚
   â”‚ WHERE order_id = ord-001       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ INSERT INTO positions          â”‚
   â”‚   cycle_id = current_cycle     â”‚
   â”‚   security_id = (AAPL's ID)    â”‚
   â”‚   side = 'long'                â”‚
   â”‚   quantity = 100               â”‚
   â”‚   entry_price = 149.95         â”‚
   â”‚   status = 'open'              â”‚
   â”‚ RETURNING position_id          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ UPDATE orders SET              â”‚
   â”‚   position_id = pos-001        â”‚  â† Link order to position
   â”‚ WHERE order_id = ord-001       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
6. PROTECTION ORDERS (Created by Alpaca bracket)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   Alpaca automatically creates:
   - Stop Loss Order (child of bracket)
   - Take Profit Order (child of bracket)
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ INSERT INTO orders (stop loss) â”‚
   â”‚   position_id = pos-001        â”‚  â† Linked immediately
   â”‚   parent_order_id = ord-001    â”‚
   â”‚   side = 'sell'                â”‚
   â”‚   order_type = 'stop'          â”‚
   â”‚   stop_price = 145.00          â”‚
   â”‚   status = 'accepted'          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ INSERT INTO orders (take prof) â”‚
   â”‚   position_id = pos-001        â”‚  â† Linked immediately
   â”‚   parent_order_id = ord-001    â”‚
   â”‚   side = 'sell'                â”‚
   â”‚   order_type = 'limit'         â”‚
   â”‚   limit_price = 160.00         â”‚
   â”‚   status = 'accepted'          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
7. EXIT FILLS â†’ CLOSE POSITION
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   
   When take profit hits:
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ UPDATE orders SET              â”‚
   â”‚   status = 'filled'            â”‚  (take profit order)
   â”‚ WHERE order_id = ord-003       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ UPDATE orders SET              â”‚
   â”‚   status = 'cancelled'         â”‚  (stop loss - OCO)
   â”‚ WHERE order_id = ord-002       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ UPDATE positions SET           â”‚
   â”‚   status = 'closed'            â”‚
   â”‚   exit_price = 160.00          â”‚
   â”‚   realized_pnl = +$1,005.00    â”‚
   â”‚   closed_at = NOW()            â”‚
   â”‚ WHERE position_id = pos-001    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FINAL STATE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Position: CLOSED with realized P&L
Orders:
  - Entry order (ord-001): FILLED
  - Stop loss (ord-002): CANCELLED (OCO)
  - Take profit (ord-003): FILLED
```

### 3.3 WORKFLOW C: Doctor Claude Monitoring

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DOCTOR CLAUDE MONITORING WORKFLOW                       â”‚
â”‚                      (Active During Market Hours)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MARKET OPEN (09:30 AM ET)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SESSION START                                                               â”‚
â”‚                                                                              â”‚
â”‚  log_activity.py --type startup                                             â”‚
â”‚    â””â”€â”€ INSERT INTO claude_activity_log                                      â”‚
â”‚          observation_type = 'startup'                                        â”‚
â”‚          decision = 'no_action'                                              â”‚
â”‚          reasoning = 'Beginning monitoring session'                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MONITORING LOOP (Every 5 minutes)                                          â”‚
â”‚                                                                              â”‚
â”‚  while market_open:                                                          â”‚
â”‚    â”‚                                                                         â”‚
â”‚    â–¼                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    STEP 1: RUN DIAGNOSTICS                              â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  trade_watchdog.py                                                      â”‚â”‚
â”‚  â”‚    â”‚                                                                    â”‚â”‚
â”‚  â”‚    â”œâ”€â”€ Query v_trade_pipeline_status                                    â”‚â”‚
â”‚  â”‚    â”‚     â””â”€â”€ Current cycle, positions, orders                           â”‚â”‚
â”‚  â”‚    â”‚                                                                    â”‚â”‚
â”‚  â”‚    â”œâ”€â”€ Check for stuck orders                                           â”‚â”‚
â”‚  â”‚    â”‚     â””â”€â”€ SELECT * FROM orders WHERE status IN ('submitted',        â”‚â”‚
â”‚  â”‚    â”‚         'accepted') AND submitted_at < NOW() - INTERVAL '5 min'   â”‚â”‚
â”‚  â”‚    â”‚                                                                    â”‚â”‚
â”‚  â”‚    â”œâ”€â”€ Connect to Alpaca API                                            â”‚â”‚
â”‚  â”‚    â”‚     â””â”€â”€ get_all_positions()                                        â”‚â”‚
â”‚  â”‚    â”‚     â””â”€â”€ get_order_by_id() for each open order                     â”‚â”‚
â”‚  â”‚    â”‚                                                                    â”‚â”‚
â”‚  â”‚    â”œâ”€â”€ Compare DB state vs Alpaca state                                 â”‚â”‚
â”‚  â”‚    â”‚     â””â”€â”€ Position reconciliation                                    â”‚â”‚
â”‚  â”‚    â”‚     â””â”€â”€ Order status reconciliation                                â”‚â”‚
â”‚  â”‚    â”‚                                                                    â”‚â”‚
â”‚  â”‚    â””â”€â”€ Output JSON with issues found                                    â”‚â”‚
â”‚  â”‚          {                                                               â”‚â”‚
â”‚  â”‚            "timestamp": "...",                                           â”‚â”‚
â”‚  â”‚            "pipeline": { ... },                                          â”‚â”‚
â”‚  â”‚            "issues": [ ... ],                                            â”‚â”‚
â”‚  â”‚            "summary": {                                                  â”‚â”‚
â”‚  â”‚              "total_issues": N,                                          â”‚â”‚
â”‚  â”‚              "critical": N,                                              â”‚â”‚
â”‚  â”‚              "warnings": N,                                              â”‚â”‚
â”‚  â”‚              "status": "OK|WARNING|CRITICAL"                             â”‚â”‚
â”‚  â”‚            }                                                             â”‚â”‚
â”‚  â”‚          }                                                               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚    â”‚                                                                         â”‚
â”‚    â–¼                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    STEP 2: DECISION FRAMEWORK                           â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  For each issue found:                                                  â”‚â”‚
â”‚  â”‚    â”‚                                                                    â”‚â”‚
â”‚  â”‚    â”œâ”€â”€ Query doctor_claude_rules                                        â”‚â”‚
â”‚  â”‚    â”‚     â””â”€â”€ SELECT auto_fix_enabled, escalation_priority              â”‚â”‚
â”‚  â”‚    â”‚         FROM doctor_claude_rules                                   â”‚â”‚
â”‚  â”‚    â”‚         WHERE issue_type = ?                                       â”‚â”‚
â”‚  â”‚    â”‚                                                                    â”‚â”‚
â”‚  â”‚    â–¼                                                                    â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚â”‚
â”‚  â”‚  â”‚              DECISION TREE                                          â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â”‚  Is auto_fix_enabled?                                               â”‚â”‚â”‚
â”‚  â”‚  â”‚      â”‚                                                              â”‚â”‚â”‚
â”‚  â”‚  â”‚      â”œâ”€â”€ YES â”€â”€â–¶ Is rate_limit_ok?                                  â”‚â”‚â”‚
â”‚  â”‚  â”‚      â”‚               â”‚                                              â”‚â”‚â”‚
â”‚  â”‚  â”‚      â”‚               â”œâ”€â”€ YES â”€â”€â–¶ Execute auto-fix                   â”‚â”‚â”‚
â”‚  â”‚  â”‚      â”‚               â”‚           (DB update only, never Alpaca)     â”‚â”‚â”‚
â”‚  â”‚  â”‚      â”‚               â”‚                                              â”‚â”‚â”‚
â”‚  â”‚  â”‚      â”‚               â””â”€â”€ NO â”€â”€â–¶ Defer, log for later               â”‚â”‚â”‚
â”‚  â”‚  â”‚      â”‚                                                              â”‚â”‚â”‚
â”‚  â”‚  â”‚      â””â”€â”€ NO â”€â”€â–¶ Is severity CRITICAL?                               â”‚â”‚â”‚
â”‚  â”‚  â”‚                    â”‚                                                â”‚â”‚â”‚
â”‚  â”‚  â”‚                    â”œâ”€â”€ YES â”€â”€â–¶ Escalate immediately                 â”‚â”‚â”‚
â”‚  â”‚  â”‚                    â”‚           (Email alert to Craig)               â”‚â”‚â”‚
â”‚  â”‚  â”‚                    â”‚                                                â”‚â”‚â”‚
â”‚  â”‚  â”‚                    â””â”€â”€ NO â”€â”€â–¶ Log for daily review                 â”‚â”‚â”‚
â”‚  â”‚  â”‚                                                                     â”‚â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚    â”‚                                                                         â”‚
â”‚    â–¼                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                    STEP 3: EXECUTE & LOG                                â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  If auto-fix:                                                           â”‚â”‚
â”‚  â”‚    Execute SQL update                                                   â”‚â”‚
â”‚  â”‚    Verify fix applied                                                   â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  log_activity.py                                                        â”‚â”‚
â”‚  â”‚    --type watchdog_run                                                  â”‚â”‚
â”‚  â”‚    --decision [auto_fix|escalate|monitor|no_action]                     â”‚â”‚
â”‚  â”‚    --reasoning "..."                                                    â”‚â”‚
â”‚  â”‚    --action-type [sql_update|alert_sent|none]                           â”‚â”‚
â”‚  â”‚    --result [success|failed|skipped]                                    â”‚â”‚
â”‚  â”‚    --issue-type [ORDER_STATUS_MISMATCH|PHANTOM_POSITION|...]            â”‚â”‚
â”‚  â”‚    --severity [CRITICAL|WARNING|INFO]                                   â”‚â”‚
â”‚  â”‚                                                                         â”‚â”‚
â”‚  â”‚  INSERT INTO claude_activity_log (...)                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚    â”‚                                                                         â”‚
â”‚    â””â”€â”€ sleep 300 seconds (5 minutes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                                                           â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â”‚                                                                     â”‚
         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
MARKET CLOSE (04:00 PM ET)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SESSION END                                                                 â”‚
â”‚                                                                              â”‚
â”‚  log_activity.py --type shutdown                                            â”‚
â”‚    â””â”€â”€ INSERT INTO claude_activity_log                                      â”‚
â”‚          observation_type = 'shutdown'                                       â”‚
â”‚          session summary statistics                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DOCTOR CLAUDE SAFETY BOUNDARIES                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  WILL DO (Safe Operations):                                                  â”‚
â”‚  âœ… Sync DB state to match Alpaca (read broker, write DB)                   â”‚
â”‚  âœ… Mark phantom positions as closed (already gone from broker)             â”‚
â”‚  âœ… Update order statuses to match Alpaca                                   â”‚
â”‚  âœ… Log all observations and decisions                                      â”‚
â”‚  âœ… Alert Craig via email for critical issues                               â”‚
â”‚                                                                              â”‚
â”‚  WILL NEVER DO (Dangerous Operations):                                       â”‚
â”‚  âŒ Close positions in Alpaca (real money!)                                 â”‚
â”‚  âŒ Submit new orders                                                       â”‚
â”‚  âŒ Modify risk parameters                                                  â”‚
â”‚  âŒ Override emergency stops                                                â”‚
â”‚  âŒ Act on orphan positions (money in Alpaca not tracked in DB)             â”‚
â”‚  âŒ Exceed max_auto_fixes_per_hour rate limit                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.4 WORKFLOW D: Emergency Stop

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        EMERGENCY STOP WORKFLOW                               â”‚
â”‚                    (Automatic Risk Protection)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TRIGGER CONDITIONS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â€¢ Daily loss >= $2,000 (configurable via risk_parameters.yaml)
  â€¢ Detected by Risk Manager's continuous monitoring (every 60 seconds)

EXECUTION FLOW:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Risk Manager (5004)                    Database                    Alpaca
      â”‚                                    â”‚                          â”‚
      â”‚  Check daily P&L                   â”‚                          â”‚
      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                          â”‚
      â”‚                                    â”‚                          â”‚
      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
      â”‚  daily_pnl = -$2,050              â”‚                          â”‚
      â”‚                                    â”‚                          â”‚
      â”‚                                    â”‚                          â”‚
      â”‚  âš ï¸  DAILY LOSS LIMIT EXCEEDED    â”‚                          â”‚
      â”‚                                    â”‚                          â”‚
      â–¼                                    â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STEP 1: CLOSE ALL POSITIONS                          â”‚
â”‚                                                                              â”‚
â”‚  For each open position:                                                     â”‚
â”‚                                                                              â”‚
â”‚  Risk Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Alpaca    â”‚
â”‚               close_position(symbol)                                         â”‚
â”‚               â””â”€â”€ submit_market_order(side='sell')                          â”‚
â”‚                                                                              â”‚
â”‚                                                                              â”‚
â”‚  Risk Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Database          â”‚
â”‚               UPDATE positions SET status = 'closed', close_reason = 'EMERGENCY_STOP'
â”‚               UPDATE trading_cycles SET status = 'stopped'                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STEP 2: CANCEL PENDING ORDERS                        â”‚
â”‚                                                                              â”‚
â”‚  Risk Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Alpaca    â”‚
â”‚               cancel_all_orders()                                            â”‚
â”‚                                                                              â”‚
â”‚  Risk Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ Database          â”‚
â”‚               UPDATE orders SET status = 'cancelled'                         â”‚
â”‚               WHERE status IN ('submitted', 'accepted', 'pending')           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STEP 3: SEND ALERT                                   â”‚
â”‚                                                                              â”‚
â”‚  Alert Manager                                                               â”‚
â”‚    â””â”€â”€ Email to Craig:                                                       â”‚
â”‚          Subject: "ğŸ›‘ EMERGENCY STOP - Catalyst Trading System"             â”‚
â”‚          Body:                                                               â”‚
â”‚            - Reason: Daily loss limit exceeded                              â”‚
â”‚            - Daily P&L: -$2,050                                             â”‚
â”‚            - Positions closed: 3                                            â”‚
â”‚            - Orders cancelled: 2                                            â”‚
â”‚            - Time: 2025-12-27 14:32:15 ET                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         STEP 4: LOG ACTIVITY                                 â”‚
â”‚                                                                              â”‚
â”‚  INSERT INTO risk_events                                                     â”‚
â”‚    event_type = 'EMERGENCY_STOP'                                            â”‚
â”‚    daily_pnl = -2050.00                                                     â”‚
â”‚    positions_closed = 3                                                      â”‚
â”‚    orders_cancelled = 2                                                      â”‚
â”‚                                                                              â”‚
â”‚  Trading is HALTED for the rest of the day                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POST-CONDITIONS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â€¢ trading_cycles.status = 'stopped'
  â€¢ All positions closed
  â€¢ All orders cancelled
  â€¢ No new trades accepted until next day
  â€¢ Craig notified via email
```

### 3.5 WORKFLOW E: Position State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        POSITION STATE MACHINE                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   PENDING   â”‚ â—€â”€â”€ Entry order created but not filled
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                â”‚                â”‚
          â”‚ entry          â”‚ entry          â”‚ entry order
          â”‚ fills          â”‚ rejected       â”‚ cancelled
          â”‚                â”‚                â”‚
          â–¼                â–¼                â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚  OPEN   â”‚     â”‚ FAILED  â”‚     â”‚ CANCELLED â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚              â–²                 â–²
          â”‚              â”‚                 â”‚
          â”‚ exit         â”‚                 â”‚
          â”‚ fills        â”‚                 â”‚
          â”‚              â”‚                 â”‚
          â–¼              â”‚                 â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                 â”‚
     â”‚ CLOSED  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     (if position never had fills)


STATE DEFINITIONS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ State        â”‚ Description                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ pending      â”‚ Entry order submitted, waiting for fill                    â”‚
â”‚              â”‚ Entry orders: submitted/accepted                            â”‚
â”‚              â”‚ Exit orders: None                                           â”‚
â”‚              â”‚ Quantity: 0                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ open         â”‚ Entry filled, holding shares                               â”‚
â”‚              â”‚ Entry orders: filled                                        â”‚
â”‚              â”‚ Exit orders: accepted/pending                               â”‚
â”‚              â”‚ Quantity: > 0                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ closed       â”‚ All shares exited                                          â”‚
â”‚              â”‚ Entry orders: filled                                        â”‚
â”‚              â”‚ Exit orders: filled                                         â”‚
â”‚              â”‚ Quantity: 0                                                 â”‚
â”‚              â”‚ realized_pnl: calculated                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ cancelled    â”‚ Entry never filled                                         â”‚
â”‚              â”‚ Entry orders: cancelled/expired                             â”‚
â”‚              â”‚ Exit orders: None                                           â”‚
â”‚              â”‚ Quantity: 0                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ failed       â”‚ Entry rejected by broker                                   â”‚
â”‚              â”‚ Entry orders: rejected                                      â”‚
â”‚              â”‚ Exit orders: None                                           â”‚
â”‚              â”‚ Quantity: 0                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.6 WORKFLOW F: Order State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ORDER STATE MACHINE                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  created  â”‚ â—€â”€â”€ Order record created in DB
                         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     (before Alpaca submission)
                               â”‚
                               â”‚ submit to Alpaca
                               â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ submitted â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚             â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â”‚
           â”‚                   â”‚                    â”‚
           â”‚ broker            â”‚ broker             â”‚ broker
           â”‚ rejects           â”‚ accepts            â”‚ error
           â”‚                   â”‚                    â”‚
           â–¼                   â–¼                    â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ rejected  â”‚       â”‚ accepted  â”‚       â”‚   error   â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                â”‚                â”‚
              â”‚ partial        â”‚ full           â”‚ cancel
              â”‚ fill           â”‚ fill           â”‚ request
              â”‚                â”‚                â”‚
              â–¼                â–¼                â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ partially â”‚â”€â”€â”€â–¶â”‚  filled   â”‚    â”‚ cancelled â”‚
        â”‚  filled   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â–²                â–²
              â”‚                â”‚                â”‚
              â”‚ remaining      â”‚                â”‚
              â”‚ fills          â”‚                â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
                                                â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
                         â”‚  expired  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     (if not filled by EOD)


ORDER TYPES:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Type        â”‚ Usage                                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ market      â”‚ Immediate execution at best available price                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ limit       â”‚ Execute only at specified price or better                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ stop        â”‚ Becomes market order when stop price hit (stop loss)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ stop_limit  â”‚ Becomes limit order when stop price hit                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ bracket     â”‚ Entry + Stop Loss + Take Profit (OCO)                       â”‚
â”‚             â”‚ RECOMMENDED for autonomous trading                          â”‚
â”‚             â”‚ CRITICAL: Must set order_class=OrderClass.BRACKET           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.7 WORKFLOW G: CRON Schedule

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CRON SCHEDULE                                       â”‚
â”‚                    (All times US Eastern)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TIME (ET)     SCRIPT                         PURPOSE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

PRE-MARKET
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
09:15 AM      trigger-workflow.sh            Pre-market scan

MARKET HOURS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
09:30 AM      trigger-workflow.sh            Market open scan
10:30 AM      trigger-workflow.sh            Mid-morning scan
12:00 PM      trigger-workflow.sh            Midday scan
01:30 PM      trigger-workflow.sh            Early afternoon scan
03:00 PM      trigger-workflow.sh            Late afternoon scan

MARKET CLOSE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
04:00 PM      close-positions.sh             Close all positions
              trigger-workflow.sh            End of day scan

CONTINUOUS (Every 15 minutes)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
*/15 * * *    health-check.sh               Service health monitoring

DOCTOR CLAUDE (Every 5 minutes during market hours)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
*/5 9-16 * *  trade_watchdog.py              Trade lifecycle monitoring


CRONTAB FORMAT:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# UTC times (Market hours: 14:30 - 21:00 UTC = 9:30 AM - 4:00 PM ET)

# Pre-market scan
15 14 * * 1-5    /scripts/trigger-workflow.sh

# Market open scan  
30 14 * * 1-5    /scripts/trigger-workflow.sh

# Intraday scans
30 15 * * 1-5    /scripts/trigger-workflow.sh
00 17 * * 1-5    /scripts/trigger-workflow.sh
30 18 * * 1-5    /scripts/trigger-workflow.sh
00 20 * * 1-5    /scripts/trigger-workflow.sh

# Market close
00 21 * * 1-5    /scripts/close-positions.sh

# Health checks (every 15 minutes)
*/15 * * * *     /scripts/health-check.sh

# Doctor Claude (every 5 minutes during market hours)
*/5 14-21 * * 1-5  python3 /scripts/trade_watchdog.py >> /var/log/catalyst/watchdog.log 2>&1
```

---

## 4. Service-by-Service Audit

### 4.1 Orchestration Service

| Attribute | Design Doc | Implementation | Status |
|-----------|------------|----------------|--------|
| Port | 5000 | 5000 | âœ… Match |
| Protocol | MCP + REST | FastMCP HTTP | âœ… Match |
| Version | - | v6.0.3 | âœ… Documented |
| Health endpoint | /health | /health | âœ… Match |
| MCP endpoint | /mcp | /mcp | âœ… Match |

**MCP Tools Audit:**

| Tool | Spec | Implementation | Status |
|------|------|----------------|--------|
| execute_trade | âœ… | âœ… | âœ… Match |
| get_positions | âœ… | âœ… | âœ… Match |
| close_position | âœ… | âœ… | âœ… Match |
| emergency_stop | âœ… | âœ… | âœ… Match |
| get_scan_results | âœ… | âœ… | âœ… Match |

**Service URL Configuration:**

```python
# From orchestration-service.py
SCANNER_URL = "http://scanner:5001"      # âœ… Correct
PATTERN_URL = "http://pattern:5002"      # âœ… Correct
TECHNICAL_URL = "http://technical:5003"  # âœ… Correct
RISK_URL = "http://risk-manager:5004"    # âœ… Correct
TRADING_URL = "http://trading:5005"      # âœ… Correct
NEWS_URL = "http://news:5008"            # âœ… Correct
REPORTING_URL = "http://reporting:5009"  # âœ… Correct
```

### 4.2 Scanner Service

| Attribute | Design Doc | Implementation | Status |
|-----------|------------|----------------|--------|
| Port | 5001 | 5001 | âœ… Match |
| Version | - | v6.1.0 | âœ… Documented |
| POST /api/v1/scan | âœ… | âœ… | âœ… Match |
| GET /api/v1/candidates | âœ… | âœ… | âœ… Match |

**Scoring Logic (v6.1.0 Update):**

| Change | Description | Status |
|--------|-------------|--------|
| RSI calculation | Added overbought filter | âœ… Implemented |
| Momentum penalty | 10%+ moves penalized | âœ… Implemented |
| Optimal zone | 3-7% moves score highest | âœ… Implemented |
| Volume spike | 3x+ with high momentum = warning | âœ… Implemented |

### 4.3 Trading Service

| Attribute | Design Doc | Implementation | Status |
|-----------|------------|----------------|--------|
| Port | 5005 | 5005 | âœ… Match |
| Version | - | v8.3.0 | âœ… Documented |
| POST /api/v1/orders | âœ… | âœ… | âœ… Match |
| GET /api/v1/orders/{id} | âœ… | âœ… | âœ… Match |
| GET /api/v1/positions | âœ… | âœ… | âœ… Match |
| POST /api/v1/positions/{id}/close | âœ… | âœ… | âœ… Match |
| POST /api/v1/sync | âœ… | âœ… | âœ… Match |

**âš ï¸ CRITICAL FINDING: alpaca_order_id in positions table**

```python
# From trading-service.py v8.3.0:
await conn.execute("""
    UPDATE positions
    SET alpaca_order_id = $1,
        alpaca_status = $2
    WHERE position_id = $3
""", alpaca_order_id, alpaca_status, position_id)
```

**This VIOLATES ARCHITECTURE-RULES.md Rule 1:**
> "Orders and Positions are Separate Entities"
> "Forbidden: UPDATE positions SET alpaca_order_id = $1, alpaca_status = $2 ..."

**Impact:** The trading-service.py is storing order data in the positions table instead of using a separate orders table.

### 4.4 Risk Manager Service

| Attribute | Design Doc | Implementation | Status |
|-----------|------------|----------------|--------|
| Port | 5004 | 5004 | âœ… Match |
| Version | - | v7.1.0 | âœ… Documented |
| POST /api/v1/validate | âœ… | âœ… | âœ… Match |
| GET /api/v1/status | âœ… | âœ… | âœ… Match |
| POST /api/v1/emergency-stop | âœ… | âœ… | âœ… Match |

**Features (v7.1.0):**

| Feature | Status |
|---------|--------|
| PositionMonitor class | âœ… Implemented |
| Fallback stop-loss (every 30s) | âœ… Implemented |
| close_reason column | âœ… Implemented |
| Alert on fallback closes | âœ… Implemented |

### 4.5 Workflow Service

| Attribute | Design Doc | Implementation | Status |
|-----------|------------|----------------|--------|
| Port | 5006 | 5006 | âœ… Match |
| Version | - | v6.0.0 | âœ… Documented |
| POST /api/v1/workflow/start | âœ… | âœ… | âœ… Match |
| POST /api/v1/workflow/stop | âœ… | âœ… | âœ… Match |
| GET /api/v1/workflow/status | âœ… | âœ… | âœ… Match |

**âš ï¸ Finding: workflow-coordinator.py also exists**

There appear to be two workflow files:
- `workflow-service.py` (v6.0.0)
- `workflow-coordinator.py` (separate file)

Need to verify which is authoritative.

### 4.6 Pattern Service

| Attribute | Design Doc | Implementation | Status |
|-----------|------------|----------------|--------|
| Port | 5002 | 5002 | âœ… Match |
| Version | - | Not specified | âš ï¸ No version header |
| POST /api/v1/detect | âœ… | âœ… | âœ… Match |
| GET /api/v1/patterns/{symbol} | âœ… | âœ… | âœ… Match |

**Pattern Types Supported:**

| Pattern | Status |
|---------|--------|
| BREAKOUT | âœ… Implemented |
| REVERSAL | âœ… Implemented |
| CONSOLIDATION | âœ… Implemented |
| CONTINUATION | âœ… Implemented |
| Bull Flag | âœ… Implemented |
| Bear Flag | âœ… Implemented |
| Cup & Handle | âœ… Implemented |
| ABCD Pattern | âœ… Implemented |
| Ascending Triangle | âœ… Implemented |
| Descending Triangle | âœ… Implemented |

**âš ï¸ Note:** Two pattern implementations exist:
- `Temp/pattern-service.py` - FastAPI service
- `catalyst-international/data/patterns.py` - PatternDetector class

### 4.7 Technical Service

| Attribute | Design Doc | Implementation | Status |
|-----------|------------|----------------|--------|
| Port | 5003 | 5003 | âœ… Match |
| Version | - | Uses 'ta' library | âœ… Documented |
| POST /api/v1/analyze | âœ… | âœ… | âœ… Match |
| GET /api/v1/indicators/{symbol}/latest | âœ… | âœ… | âœ… Match |

**Indicators Calculated:**

| Category | Indicators | Status |
|----------|------------|--------|
| Trend | SMA(20,50), EMA(12,26), MACD | âœ… |
| Momentum | RSI(14), Stochastic, Williams %R, CCI | âœ… |
| Volatility | Bollinger Bands, ATR(14) | âœ… |
| Volume | OBV, VWAP, Volume Ratio | âœ… |

**Signal Generation:**
- BUY: Score >= 70
- SELL: Score <= 30
- HOLD: 30 < Score < 70

### 4.8 News Service

| Attribute | Design Doc | Implementation | Status |
|-----------|------------|----------------|--------|
| Port | 5008 | 5008 | âœ… Match |
| Version | - | v6.0.1 | âœ… Documented |
| POST /api/v1/sentiment | âœ… | âœ… | âœ… Match |
| GET /api/v1/sentiment/{symbol} | âœ… | âœ… | âœ… Match |
| GET /api/v1/catalysts | âœ… | âœ… | âœ… Match |

**âš ï¸ Finding:** Two versions exist with schema differences:
- `services/news/news-service.py` v6.0.1 - Uses `td.timestamp`
- `Temp/news-service.py` v6.0.0 - Uses `td.full_timestamp` (wrong column name)

The v6.0.1 version fixes the column name issue.

### 4.9 Reporting Service

| Attribute | Design Doc | Implementation | Status |
|-----------|------------|----------------|--------|
| Port | 5009 | 5009 | âœ… Match |
| Version | - | v5.1.1 | âœ… Documented |
| GET /api/v1/reports/daily | âœ… | âœ… | âœ… Match |
| GET /api/v1/reports/performance | âœ… | âœ… | âœ… Match |
| GET /api/v1/reports/position-history/{symbol} | âœ… | âœ… | âœ… Match |

**Features:**

| Feature | Status |
|---------|--------|
| Daily P&L Summary | âœ… |
| Win Rate Calculation | âœ… |
| Profit Factor | âœ… |
| R-Multiple Tracking | âœ… |
| Sector Breakdown | âœ… |

### 4.10 Doctor Claude

| Component | Version | Status |
|-----------|---------|--------|
| trade_watchdog.py | v1.0.0 | âœ… Implemented |
| log_activity.py | v1.0.0 | âœ… Implemented |
| doctor_claude_monitor.sh | v1.0.0 | âœ… Implemented |
| claude_activity_log table | v1.0.0 | âœ… Schema exists |
| doctor_claude_rules table | v1.0.0 | âœ… Schema exists |

**Views:**

| View | Purpose | Status |
|------|---------|--------|
| v_trade_pipeline_status | Real-time pipeline | âœ… Created |
| v_claude_activity_summary | Daily summary | âœ… Created |
| v_recurring_issues | Pattern learning | âœ… Created |
| v_recent_escalations | Human review queue | âœ… Created |
| v_failed_actions | Investigation | âœ… Created |

---

## 5. Database Schema Audit

### 5.1 Core Tables vs Design Doc

| Table | Design Doc | Implementation | Status |
|-------|------------|----------------|--------|
| securities | âœ… v7.0 | âœ… | âœ… Match |
| sectors | âœ… v7.0 | âœ… | âœ… Match |
| trading_cycles | âœ… v7.0 | âœ… | âœ… Match |
| orders | âœ… v7.0 | âš ï¸ | ğŸ”´ See finding below |
| positions | âœ… v7.0 | âš ï¸ | ğŸ”´ See finding below |
| scan_results | âœ… v7.0 | âœ… | âœ… Match |
| claude_activity_log | âœ… v7.0 | âœ… | âœ… Match |
| doctor_claude_rules | âœ… v7.0 | âœ… | âœ… Match |

### 5.2 Critical Schema Finding

**POSITIONS TABLE VIOLATION:**

Per `database-schema.md` v7.0.0:
```sql
-- ============================================================================
-- â›” FORBIDDEN COLUMNS - These must NOT exist in positions table:
--    alpaca_order_id   -- WRONG: Use orders table
--    alpaca_status     -- WRONG: Use orders table
-- ============================================================================
```

But `trading-service.py` v8.3.0 writes to these columns:
```python
UPDATE positions SET alpaca_order_id = $1, alpaca_status = $2 ...
```

**This indicates the deployed schema may differ from the design doc.**

---

## 6. Discrepancies Found

### 6.1 ğŸ”´ CRITICAL Discrepancies

| ID | Description | Impact | Recommendation |
|----|-------------|--------|----------------|
| C1 | **Orders in Positions Table**: trading-service.py stores alpaca_order_id and alpaca_status in positions table instead of using separate orders table | Violates 3NF, makes reconciliation harder | Migrate to proper orders table |
| C2 | **alpaca_trader.py Duplication**: Multiple copies in different locations (`/trading/common/`, `/risk-manager/common/`, `/workflow/common/`, `/shared/common/`) | Version drift risk, maintenance burden | Consolidate to shared module |

### 6.2 ğŸŸ¡ WARNING Discrepancies

| ID | Description | Impact | Recommendation |
|----|-------------|--------|----------------|
| W1 | **IMPLEMENTATION-GUIDE.md shows wrong ports**: News=5002, Pattern=5003, Technical=5004, Risk=5005, Trading=5006, Workflow=5007 vs functional-spec (correct) | Documentation confusion | Update IMPLEMENTATION-GUIDE.md to match functional-spec |
| W2 | **workflow-coordinator.py vs workflow-service.py**: Both files exist | Unclear which is authoritative | Consolidate or deprecate one |
| W3 | **Version mismatch across services**: trading v8.3.0, workflow v6.0.0, reporting v5.1.1, news v6.0.1 | May indicate integration issues | Version alignment review |
| W4 | **news-service.py schema column**: Temp/news-service.py uses `td.full_timestamp` which doesn't exist | Query will fail | Use v6.0.1 which has correct `td.timestamp` |
| W5 | **Pattern service missing version header** | Can't track deployments | Add standard version header |

### 6.3 ğŸ”µ INFO Findings

| ID | Description | Recommendation |
|----|-------------|----------------|
| I1 | Two pattern implementations exist (FastAPI service + PatternDetector class) | Clarify which is production |
| I2 | Dockerfile versions vs service versions not aligned | Minor - cosmetic |
| I3 | Operations.md is new (v1.0.0), comprehensive but could add more examples | Continue development |
| I4 | catalyst-international folder has separate HKEX implementation | Verify no code sharing conflicts |

---

## 7. Recommendations

### 7.1 Immediate Actions (Before Next Trading Session)

1. **Verify deployed schema** - Check if positions table has forbidden columns
   ```sql
   SELECT column_name FROM information_schema.columns 
   WHERE table_name = 'positions' 
   AND column_name IN ('alpaca_order_id', 'alpaca_status');
   ```

2. **If columns exist, migration needed** - Create proper orders table and migrate

3. **Consolidate alpaca_trader.py** - Move to `services/shared/common/alpaca_trader.py` and update all imports

4. **Verify news-service.py version** - Ensure v6.0.1 (with correct `td.timestamp`) is deployed, not v6.0.0

### 7.2 Documentation Updates

| Document | Action |
|----------|--------|
| IMPLEMENTATION-GUIDE.md | Fix port assignments to match functional-specification.md |
| workflow-coordinator.py | Clarify relationship with workflow-service.py or consolidate |
| pattern-service.py | Add standard version header |
| All services | Align version numbering scheme |

### 7.3 Architecture Compliance

| Rule | Current Status | Required Action |
|------|----------------|-----------------|
| Rule 1: Orders â‰  Positions | âŒ Violated | Create orders table migration |
| Rule 2: Schema First | âœ… Compliant | No action |
| Rule 3: Migration Scripts | âš ï¸ Partial | Verify migration history |
| Rule 4: Alpaca SDK | âš ï¸ Mixed (duplication) | Consolidate alpaca_trader.py |
| Rule 5: Doctor Claude Monitors Orders | âš ï¸ Can't verify | Need orders table first |

### 7.4 Service Version Alignment

Current versions discovered:

| Service | Version | Recommended Action |
|---------|---------|-------------------|
| Orchestration | v6.0.3 | Baseline |
| Scanner | v6.1.0 | Baseline |
| Pattern | Not versioned | Add v6.0.0 header |
| Technical | Not versioned | Add v6.0.0 header |
| Risk Manager | v7.1.0 | Baseline |
| Trading | v8.3.0 | Baseline (fix schema issue) |
| Workflow | v6.0.0 | Baseline |
| News | v6.0.1 | Baseline |
| Reporting | v5.1.1 | Consider updating to v6.x |
| Doctor Claude | v1.0.0 | Baseline |

---

## Appendix A: File Locations

### Design Documents
```
Documentation/Design/
â”œâ”€â”€ architecture.md                 (v7.0.0)
â”œâ”€â”€ functional-specification.md     (v7.0.0)
â”œâ”€â”€ database-schema.md              (v7.0.0)
â”œâ”€â”€ operations.md                   (v1.0.0)
â””â”€â”€ ARCHITECTURE-RULES.md           (v1.0.0)
```

### Implementation Files
```
services/
â”œâ”€â”€ orchestration/
â”‚   â””â”€â”€ orchestration-service.py    (v6.0.3)
â”œâ”€â”€ scanner/
â”‚   â””â”€â”€ scanner-service.py          (v6.1.0)
â”œâ”€â”€ pattern/
â”‚   â””â”€â”€ pattern-service.py          (no version)
â”œâ”€â”€ technical/
â”‚   â””â”€â”€ technical-service.py        (no version)
â”œâ”€â”€ trading/
â”‚   â”œâ”€â”€ trading-service.py          (v8.3.0)
â”‚   â””â”€â”€ common/
â”‚       â””â”€â”€ alpaca_trader.py        (duplicate!)
â”œâ”€â”€ risk-manager/
â”‚   â”œâ”€â”€ risk-manager-service.py     (v7.1.0)
â”‚   â””â”€â”€ common/
â”‚       â””â”€â”€ alpaca_trader.py        (duplicate!)
â”œâ”€â”€ workflow/
â”‚   â”œâ”€â”€ workflow-service.py         (v6.0.0)
â”‚   â”œâ”€â”€ workflow-coordinator.py     (exists - clarify)
â”‚   â””â”€â”€ common/
â”‚       â””â”€â”€ alpaca_trader.py        (duplicate!)
â”œâ”€â”€ news/
â”‚   â””â”€â”€ news-service.py             (v6.0.1)
â”œâ”€â”€ reporting/
â”‚   â””â”€â”€ reporting-service.py        (v5.1.1)
â””â”€â”€ shared/
    â””â”€â”€ common/
        â””â”€â”€ alpaca_trader.py        (should be authoritative)
```

### Doctor Claude Scripts
```
scripts/
â”œâ”€â”€ trade_watchdog.py               (v1.0.0)
â”œâ”€â”€ log_activity.py                 (v1.0.0)
â””â”€â”€ doctor_claude_monitor.sh        (v1.0.0)
```

### International System (HKEX)
```
catalyst-international/
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ market.py                   (MarketData class)
â”‚   â”œâ”€â”€ patterns.py                 (PatternDetector class)
â”‚   â””â”€â”€ news.py                     (NewsClient class)
â”œâ”€â”€ tools.py                        (Claude tool definitions)
â””â”€â”€ config/prompts/system.md        (Agent system prompt)
```

---

## Appendix B: Complete Service Endpoint Matrix

| Service | Port | Health | Primary Endpoints |
|---------|------|--------|-------------------|
| Orchestration | 5000 | `/health` | `/mcp` (MCP protocol) |
| Scanner | 5001 | `/health` | `POST /api/v1/scan`, `GET /api/v1/candidates` |
| Pattern | 5002 | `/health` | `POST /api/v1/detect`, `GET /api/v1/patterns/{symbol}` |
| Technical | 5003 | `/health` | `POST /api/v1/analyze`, `GET /api/v1/indicators/{symbol}/latest` |
| Risk Manager | 5004 | `/health` | `POST /api/v1/validate`, `GET /api/v1/status`, `POST /api/v1/emergency-stop` |
| Trading | 5005 | `/health` | `POST /api/v1/orders`, `GET /api/v1/positions`, `POST /api/v1/sync` |
| Workflow | 5006 | `/health` | `POST /api/v1/workflow/start`, `GET /api/v1/workflow/status` |
| News | 5008 | `/health` | `POST /api/v1/sentiment`, `GET /api/v1/sentiment/{symbol}`, `GET /api/v1/catalysts` |
| Reporting | 5009 | `/health` | `GET /api/v1/reports/daily`, `GET /api/v1/reports/performance` |

---

**END OF WORKFLOW & AUDIT DOCUMENT**

*Full Audit Completed by Claude Opus 4.5*
*Date: 2025-12-27*
*All 10 services audited against design documents v7.0.0*
